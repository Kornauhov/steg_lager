<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Steg PRO - Lagerverwaltung</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #facc15; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .grid-cell { transition: all 0.2s ease-in-out; }
    .grid-cell:active { transform: scale(0.9); }
    .glass-effect { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-50">
  <!-- ✅ Error overlay so white screen becomes a readable error -->
  <script>
    (function () {
      function show(msg) {
        document.body.innerHTML =
          "<pre style='white-space:pre-wrap;padding:16px;font:14px/1.4 monospace;background:#0b1220;color:#fca5a5'>" +
          msg + "</pre>";
      }

      window.addEventListener("error", (e) => {
        const msg =
          "JS ERROR:\n" + (e.message || e.error) + "\n\n" +
          (e.filename ? (e.filename + ":" + e.lineno + ":" + e.colno + "\n\n") : "") +
          (e.error && e.error.stack ? e.error.stack : "");
        show(msg);
      });

      window.addEventListener("unhandledrejection", (e) => {
        const msg =
          "PROMISE ERROR:\n" + (e.reason?.message || e.reason) + "\n\n" +
          (e.reason?.stack || "");
        show(msg);
      });

      // Warn if opened via file://
      if (location.protocol === "file:") {
        console.warn("You opened via file://. Use a local server (http://localhost:...) for Firebase ESM imports.");
      }
    })();
  </script>

  <div id="root"></div>

  <!-- ✅ Firebase SDK loader (ESM). Needs http(s) to work reliably -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, collectionGroup, doc, setDoc,
      onSnapshot, deleteDoc, updateDoc, getDoc, query, where
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    window.FirebaseSDK = {
      initializeApp, getFirestore, collection, collectionGroup, doc, setDoc,
      onSnapshot, deleteDoc, updateDoc, getDoc, query, where,
      getAuth, signInAnonymously, onAuthStateChanged
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ✅ Fail fast if FirebaseSDK didn't load
    if (!window.FirebaseSDK) {
      throw new Error("FirebaseSDK wurde nicht geladen. Öffne die Seite über http:// (lokaler Server), nicht file://");
    }

    const {
      initializeApp, getFirestore, collection, collectionGroup, doc, setDoc,
      onSnapshot, deleteDoc, updateDoc, getDoc, query, where,
      getAuth, signInAnonymously, onAuthStateChanged
    } = window.FirebaseSDK;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBGqPXXcmJTbL3PVrn-PKL0Gig45r6GPbQ",
      authDomain: "steg-lager-test.firebaseapp.com",
      databaseURL: "https://steg-lager-test-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "steg-lager-test",
      storageBucket: "steg-lager-test.firebasestorage.app",
      messagingSenderId: "655203951825",
      appId: "1:655203951825:web:9edcfb40f29ed70f61d1f0",
      measurementId: "G-Q6FX41P556"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // App-ID bleibt public
    const APP_ID = "stege-lager-v1";

    const Icon = ({ name, size = 20, className = "" }) => {
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, className]);
      return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
    };

    const safeDocId = (s) => String(s || "").replace(/\//g, "_").trim();
    const slotIdFrom = (shelf, level) => `${String(shelf)}_L${Number(level)}`;

    const deriveFromPath = (path) => {
      const parts = String(path).split("/");
      const idx = parts.indexOf("slots");
      if (idx === -1) return { slotId: null, shelf: null, level: null };
      const slotId = parts[idx + 1] || null;
      if (!slotId) return { slotId: null, shelf: null, level: null };

      const m = String(slotId).match(/^(.+)_L(\d+)$/);
      if (!m) return { slotId, shelf: null, level: null };
      return { slotId, shelf: m[1], level: Number(m[2]) };
    };

    function App() {
      const [activeTab, setActiveTab] = useState("dashboard");
      const [loading, setLoading] = useState(true);
      const [user, setUser] = useState(null);

      const [rawItems, setRawItems] = useState([]);
      const [stegItems, setStegItems] = useState([]);
      const [masterItems, setMasterItems] = useState([]);

      const [searchQuery, setSearchQuery] = useState("");

      // Forms
      const [newStock, setNewStock] = useState({
        itemKey: "",
        shelf: "C1",
        level: 1,
        qty: "",
        source: "anlieferung", // anlieferung | produktion
        reference: "",         // Pflicht
        note: ""               // optional
      });

      const [outStock, setOutStock] = useState({ entryId: "", qty: "", destination: "produktion" });
      const [moveStock, setMoveStock] = useState({ entryId: "", targetShelf: "C1", targetLevel: 1, qty: "" });

      const shelves = useMemo(() => Array.from({ length: 38 }, (_, i) => `C${i + 1}`), []);
      const levels = [5, 4, 3, 2, 1];

      // Auth
      useEffect(() => {
        const init = async () => {
          try { await signInAnonymously(auth); }
          catch (e) { console.error("Auth Error:", e); }
        };
        init();

        const unsub = onAuthStateChanged(auth, (u) => {
          if (u) { setUser(u); setLoading(false); }
        });
        return () => unsub();
      }, []);

      // Firestore subscriptions
      useEffect(() => {
        if (!user) return;

        const itemsQ = query(
          collectionGroup(db, "items"),
          where("appId", "==", APP_ID)
        );

        const unsubItems = onSnapshot(
          itemsQ,
          (snap) => {
            const docs = snap.docs.map(d => ({
              __path: d.ref.path,
              __id: d.id,
              ...d.data()
            }));
            console.log("ITEMS snap:", snap.size);
            setRawItems(docs);
          },
          (err) => console.error("Items fetch error:", err)
        );

        const unsubSteg = onSnapshot(
          collection(db, "artifacts", APP_ID, "public", "data", "steg_items"),
          (snap) => {
            const items = snap.docs.map(d => {
              const data = d.data();
              return { id: d.id, code: data.code || data.name || d.id, ...data };
            }).sort((a,b) => String(a.code).localeCompare(String(b.code)));
            setStegItems(items);
          },
          (err) => console.error("Steg items fetch error:", err)
        );

        const unsubMaster = onSnapshot(
          collection(db, "artifacts", APP_ID, "public", "data", "master_items"),
          (snap) => setMasterItems(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
          (err) => console.error("Master items fetch error:", err)
        );

        return () => { unsubItems(); unsubSteg(); unsubMaster(); };
      }, [user]);

      // Normalize items
      const itemDocs = useMemo(() => {
        const out = [];
        for (const d of rawItems) {
          const derived = deriveFromPath(d.__path || "");
          const shelf = d.shelf ?? d.location?.shelf ?? derived.shelf;
          const level = Number(d.level ?? d.location?.level ?? derived.level);
          const slotId = d.slotId ?? derived.slotId ?? (shelf && level ? slotIdFrom(shelf, level) : null);

          const itemKey = d.itemKey ?? d.key ?? d.code ?? d.__id;
          const quantity = Number(d.quantity) || 0;

          if (!shelf || !level || !slotId || !itemKey || quantity <= 0) continue;

          out.push({
            id: `${slotId}__${safeDocId(itemKey)}`,
            slotId, shelf, level,
            itemKey: String(itemKey),
            quantity,
            updatedAt: Number(d.updatedAt) || 0
          });
        }
        return out;
      }, [rawItems]);

      const slotMap = useMemo(() => {
        const m = new Map();
        for (const it of itemDocs) {
          const key = `${it.shelf}|${it.level}`;
          if (!m.has(key)) m.set(key, []);
          m.get(key).push(it);
        }
        for (const [k, arr] of m.entries()) {
          arr.sort((a,b) => String(a.itemKey).localeCompare(String(b.itemKey)));
          m.set(k, arr);
        }
        return m;
      }, [itemDocs]);

      const occupiedSlots = slotMap.size;
      const totalParts = useMemo(() => itemDocs.reduce((s, x) => s + (Number(x.quantity) || 0), 0), [itemDocs]);

      const debug = useMemo(() => ({
        raw: rawItems.length,
        app: itemDocs.length,
        slots: occupiedSlots,
        sum: totalParts
      }), [rawItems.length, itemDocs.length, occupiedSlots, totalParts]);

      // AWB index
      const awbIndex = useMemo(() => {
        const m = new Map();
        for (const it of masterItems) {
          const awb = it?.awb ? String(it.awb) : null;
          if (!awb) continue;
          for (const steg of [it?.steg1, it?.steg2]) {
            if (!steg) continue;
            const key = String(steg).toUpperCase();
            if (!m.has(key)) m.set(key, new Set());
            m.get(key).add(awb);
          }
        }
        return m;
      }, [masterItems]);

      const getLinkedAWBs = (stegCode) => {
        const s = awbIndex.get(String(stegCode || "").toUpperCase());
        return s ? Array.from(s) : [];
      };

      const groupedSlots = useMemo(() => {
        const rows = Array.from(slotMap.entries()).map(([key, entries]) => {
          const [shelf, levelStr] = key.split("|");
          return { shelf, level: Number(levelStr), entries };
        });
        const shelfNum = (s) => Number(String(s).replace("C","")) || 0;
        rows.sort((a,b) => {
          const ds = shelfNum(a.shelf) - shelfNum(b.shelf);
          if (ds !== 0) return ds;
          return b.level - a.level;
        });
        return rows;
      }, [slotMap]);

      const filteredSlots = useMemo(() => {
        const term = searchQuery.trim().toUpperCase();
        if (!term) return groupedSlots;
        return groupedSlots.map(slot => {
          const shelfMatch = String(slot.shelf).toUpperCase().includes(term);
          const matched = slot.entries.filter(e => {
            const keyMatch = String(e.itemKey).toUpperCase().includes(term);
            const awbMatch = getLinkedAWBs(e.itemKey).some(a => String(a).toUpperCase().includes(term));
            return keyMatch || awbMatch;
          });
          const entriesToShow = shelfMatch ? slot.entries : matched;
          if (!entriesToShow.length) return null;
          return { ...slot, entries: entriesToShow };
        }).filter(Boolean);
      }, [groupedSlots, searchQuery, awbIndex]);

      const recentStegs = useMemo(() => {
        const keys = [];
        const seen = new Set();
        const sorted = [...itemDocs].sort((a,b) => (Number(b.updatedAt)||0) - (Number(a.updatedAt)||0));
        for (const it of sorted) {
          const k = String(it.itemKey || "").trim();
          if (!k || seen.has(k)) continue;
          seen.add(k);
          keys.push(k);
          if (keys.length >= 8) break;
        }
        if (keys.length === 0) {
          for (const s of (stegItems || [])) {
            const k = String(s.code || "").trim();
            if (!k || seen.has(k)) continue;
            seen.add(k);
            keys.push(k);
            if (keys.length >= 8) break;
          }
        }
        return keys;
      }, [itemDocs, stegItems]);

      // Firestore refs
      const slotDocRef = (slotId) => doc(db, "artifacts", APP_ID, "public", "data", "slots", slotId);
      const itemDocRef = (slotId, itemKey) => doc(db, "artifacts", APP_ID, "public", "data", "slots", slotId, "items", safeDocId(itemKey));

      const handleAddStock = async (e) => {
        e.preventDefault();

        const qty = Number(newStock.qty);
        const itemKey = newStock.itemKey;
        const shelf = newStock.shelf;
        const level = Number(newStock.level);

        if (!itemKey || !shelf || !level || !qty || qty <= 0) return;
        if (!newStock.reference || !String(newStock.reference).trim()) return;

        const slotId = slotIdFrom(shelf, level);
        const sRef = slotDocRef(slotId);
        const iRef = itemDocRef(slotId, itemKey);

        try {
          await setDoc(sRef, { appId: APP_ID, slotId, shelf, level, updatedAt: Date.now() }, { merge: true });

          const snap = await getDoc(iRef);
          if (snap.exists()) {
            await updateDoc(iRef, {
              quantity: (Number(snap.data().quantity) || 0) + qty,
              updatedAt: Date.now(),
              lastSource: newStock.source,
              source: newStock.source,
              reference: String(newStock.reference || ""),
              note: String(newStock.note || "")
            });
          } else {
            await setDoc(iRef, {
              appId: APP_ID, slotId, shelf, level,
              itemKey: String(itemKey), type: "steg",
              quantity: qty,
              timestamp: Date.now(),
              updatedAt: Date.now(),
              lastSource: newStock.source,
              source: newStock.source,
              reference: String(newStock.reference || ""),
              note: String(newStock.note || "")
            });
          }

          setNewStock({ ...newStock, qty: "", itemKey: "", reference: "", note: "" });
          setActiveTab("inventory");
        } catch (err) {
          console.error("Add error:", err);
          throw err;
        }
      };

      const entryOptions = useMemo(() => {
        const shelfNum = (s) => Number(String(s).replace("C","")) || 0;
        const arr = itemDocs.map(x => ({
          entryId: `${x.slotId}__${safeDocId(x.itemKey)}`,
          slotId: x.slotId,
          shelf: x.shelf,
          level: x.level,
          itemKey: x.itemKey,
          quantity: x.quantity
        }));
        arr.sort((a,b) => {
          const ds = shelfNum(a.shelf) - shelfNum(b.shelf);
          if (ds !== 0) return ds;
          const dl = b.level - a.level;
          if (dl !== 0) return dl;
          return String(a.itemKey).localeCompare(String(b.itemKey));
        });
        return arr;
      }, [itemDocs]);

      const handleRemoveStock = async (e) => {
        e.preventDefault();
        const qty = Number(outStock.qty);
        if (!outStock.entryId || !qty || qty <= 0) return;

        const selected = entryOptions.find(x => x.entryId === outStock.entryId);
        if (!selected || selected.quantity < qty) return;

        const iRef = itemDocRef(selected.slotId, selected.itemKey);
        try {
          const newQty = selected.quantity - qty;
          if (newQty <= 0) await deleteDoc(iRef);
          else await updateDoc(iRef, { quantity: newQty, updatedAt: Date.now(), lastDestination: outStock.destination });

          setOutStock({ entryId: "", qty: "", destination: "produktion" });
          setActiveTab("inventory");
        } catch (err) {
          console.error("Remove error:", err);
          throw err;
        }
      };

      const handleMoveStock = async (e) => {
        e.preventDefault();
        const selected = entryOptions.find(x => x.entryId === moveStock.entryId);
        if (!selected) return;

        const qty = Number(moveStock.qty);
        if (!qty || qty <= 0) return;

        const targetShelf = moveStock.targetShelf;
        const targetLevel = Number(moveStock.targetLevel);
        const targetSlotId = slotIdFrom(targetShelf, targetLevel);

        const sourceRef = itemDocRef(selected.slotId, selected.itemKey);
        const targetSlotRef = slotDocRef(targetSlotId);
        const targetItemRef = itemDocRef(targetSlotId, selected.itemKey);

        try {
          const remaining = selected.quantity - qty;
          if (remaining <= 0) await deleteDoc(sourceRef);
          else await updateDoc(sourceRef, { quantity: remaining, updatedAt: Date.now() });

          await setDoc(targetSlotRef, { appId: APP_ID, slotId: targetSlotId, shelf: targetShelf, level: targetLevel, updatedAt: Date.now() }, { merge: true });

          const tSnap = await getDoc(targetItemRef);
          if (tSnap.exists()) {
            await updateDoc(targetItemRef, { quantity: (Number(tSnap.data().quantity) || 0) + qty, updatedAt: Date.now() });
          } else {
            await setDoc(targetItemRef, {
              appId: APP_ID, slotId: targetSlotId, shelf: targetShelf, level: targetLevel,
              itemKey: selected.itemKey, type: "steg",
              quantity: qty,
              timestamp: Date.now(),
              updatedAt: Date.now()
            });
          }

          setMoveStock({ entryId: "", targetShelf: "C1", targetLevel: 1, qty: "" });
          setActiveTab("inventory");
        } catch (err) {
          console.error("Move error:", err);
          throw err;
        }
      };

      if (loading) {
        return (
          <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-yellow-500">
            <div className="w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mb-6"></div>
            <p className="font-black italic uppercase tracking-widest">System wird initialisiert...</p>
            {location.protocol === "file:" && (
              <p className="mt-3 text-[11px] text-slate-300 font-bold text-center px-6">
                Hinweis: Du nutzt <span className="text-yellow-400">file://</span>. Bitte über lokalen Server öffnen (http://localhost:...).
              </p>
            )}
          </div>
        );
      }

      return (
        <div className="max-w-4xl mx-auto min-h-screen pb-32 relative">
          {/* Debug overlay */}
          <div className="fixed top-3 right-3 z-[999] bg-white/90 backdrop-blur border border-slate-200 shadow-lg rounded-2xl px-4 py-3 text-[11px] font-bold text-slate-700">
            <div>RAW docs: <span className="text-slate-900">{debug.raw}</span></div>
            <div>APP docs: <span className="text-slate-900">{debug.app}</span></div>
            <div>Slots: <span className="text-slate-900">{debug.slots}</span></div>
            <div>Sum qty: <span className="text-slate-900">{debug.sum}</span></div>
          </div>

          <header className="bg-slate-900 text-white p-6 rounded-b-[2.5rem] shadow-2xl border-b-4 border-yellow-500 sticky top-0 z-50">
            <div className="flex justify-between items-center max-w-2xl mx-auto">
              <div>
                <h1 className="text-2xl font-black italic tracking-tighter uppercase leading-none">
                  Smart Steg <span className="text-yellow-500">PRO</span>
                </h1>
                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                  Lagerverwaltung Kran-Gestell
                </p>
              </div>
              <div className="bg-slate-800 p-3 rounded-2xl text-yellow-500 shadow-inner">
                <Icon name="factory" size={24} />
              </div>
            </div>
          </header>

          <main className="max-w-2xl mx-auto mt-6 px-4">
            {activeTab === "dashboard" && (
              <div className="space-y-6">
                <div className="grid grid-cols-3 gap-3">
                  <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-200">
                    <p className="text-[9px] font-black text-slate-400 uppercase mb-1">Stege DB</p>
                    <p className="text-2xl font-black text-slate-800 leading-none">{stegItems.length}</p>
                  </div>
                  <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-200">
                    <p className="text-[9px] font-black text-slate-400 uppercase mb-1">Teile Gesamt</p>
                    <p className="text-2xl font-black text-yellow-600 leading-none">{totalParts}</p>
                  </div>
                  <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-200">
                    <p className="text-[9px] font-black text-slate-400 uppercase mb-1">Belegte Plätze</p>
                    <p className="text-2xl font-black text-slate-800 leading-none">{occupiedSlots}/190</p>
                  </div>
                </div>

                <div className="bg-slate-900 p-6 rounded-[2.5rem] shadow-2xl text-white">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xs font-black uppercase text-yellow-500 tracking-widest flex items-center gap-2">
                      <Icon name="grid" size={16} /> Aktuelle Belegung
                    </h3>
                    <span className="text-[10px] text-slate-500 font-bold">Gestell C1 - C38</span>
                  </div>

                  <div className="overflow-x-auto custom-scrollbar pb-4">
                    <div className="flex gap-2 min-w-max px-2">
                      {shelves.map(s => (
                        <div key={s} className="flex flex-col gap-1.5 items-center">
                          <span className="text-[8px] font-black text-slate-500 mb-1">{s}</span>
                          {levels.map(l => {
                            const entries = slotMap.get(`${s}|${l}`) || [];
                            const count = entries.length;
                            return (
                              <div
                                key={l}
                                className={`w-6 h-6 rounded-md grid-cell shadow-inner flex items-center justify-center ${
                                  count ? "bg-yellow-500 shadow-yellow-500/20" : "bg-slate-800 opacity-20"
                                }`}
                                title={count ? `${count} Sorten` : "leer"}
                              >
                                {count ? <span className="text-[10px] font-black text-slate-900">{count}</span> : null}
                              </div>
                            );
                          })}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="mt-4 text-[10px] text-slate-400 font-bold">
                    * Zahl im Feld = Anzahl verschiedener Sorten im Platz
                  </div>
                </div>
              </div>
            )}

            {activeTab === "inventory" && (
              <div className="space-y-4">
                <div className="relative">
                  <input
                    placeholder="Suche Steg, Regal (C1...) oder Profil/AWB..."
                    value={searchQuery}
                    onChange={e => setSearchQuery(e.target.value)}
                    className="w-full px-6 py-4 bg-white rounded-3xl shadow-lg outline-none font-bold text-slate-800 border-2 border-transparent focus:border-yellow-400 transition-all"
                  />
                  <div className="absolute right-5 top-4 text-slate-300"><Icon name="search" /></div>
                </div>

                <div className="space-y-3">
                  {filteredSlots.length === 0 ? (
                    <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 text-slate-500 font-bold italic">
                      Keine Treffer / kein Bestand.
                    </div>
                  ) : filteredSlots.map(slot => (
                    <div key={`${slot.shelf}|${slot.level}`} className="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200">
                      <div className="flex items-center justify-between mb-3">
                        <span className="text-[15px] font-black bg-slate-900 text-yellow-500 px-3 py-1 rounded-full">
                          {slot.shelf} - L{slot.level}
                        </span>
                        <span className="text-[11px] font-black text-slate-500 uppercase">
                          {slot.entries.length} Sorten
                        </span>
                      </div>

                      <div className="space-y-2">
                        {slot.entries.map(entry => {
                          const linked = getLinkedAWBs(entry.itemKey);
                          return (
                            <div key={entry.id} className="flex items-center justify-between bg-slate-50 rounded-2xl px-4 py-3 border border-slate-100">
                              <div className="min-w-0 pr-3">
                                <div className="font-black text-slate-800 truncate">{entry.itemKey}</div>
                                <div className="text-[11px] text-slate-400 font-bold uppercase truncate">
                                  {linked.length ? `Ref: ${linked.join(" | ")}` : "Einzel-Komponente"}
                                </div>
                              </div>
                              <div className="bg-white text-slate-800 px-4 py-2 rounded-xl font-black text-lg border border-slate-200">
                                {entry.quantity}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Wareneingang überarbeitet */}
            {activeTab === "add" && (
              <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-200 space-y-6">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-emerald-100 text-emerald-600 rounded-xl"><Icon name="arrow-down-to-dot" /></div>
                  <div className="flex-1">
                    <h3 className="font-black uppercase text-slate-800 italic text-xl">Wareneingang</h3>
                    <p className="text-[11px] font-bold text-slate-400">Neu-Anlieferung oder Rücklauf aus Produktion</p>
                  </div>
                </div>

                <form onSubmit={handleAddStock} className="space-y-5">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Quelle</label>
                    <div className="flex gap-2 p-1 bg-slate-100 rounded-2xl">
                      <button
                        type="button"
                        onClick={() => setNewStock({ ...newStock, source: "anlieferung" })}
                        className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${
                          newStock.source === "anlieferung" ? "bg-white shadow-sm text-emerald-600" : "text-slate-400"
                        }`}
                      >
                        Neu-Anlieferung
                      </button>

                      <button
                        type="button"
                        onClick={() => setNewStock({ ...newStock, source: "produktion" })}
                        className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${
                          newStock.source === "produktion" ? "bg-white shadow-sm text-blue-600" : "text-slate-400"
                        }`}
                      >
                        Rücklauf Produktion
                      </button>
                    </div>

                    <div className="space-y-1">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-4">
                        {newStock.source === "anlieferung" ? "Lieferschein / Referenz" : "Auftrag / Linie / Referenz"}
                        <span className="text-rose-500"> *</span>
                      </label>
                      <input
                        required
                        value={newStock.reference}
                        onChange={e => setNewStock({ ...newStock, reference: e.target.value })}
                        placeholder={newStock.source === "anlieferung" ? "z.B. LS-12345" : "z.B. Auftrag 4711 / Linie A"}
                        className={`w-full p-4 rounded-2xl font-bold border-2 outline-none ${
                          newStock.source === "anlieferung"
                            ? "bg-emerald-50 border-emerald-100 focus:border-emerald-400"
                            : "bg-blue-50 border-blue-100 focus:border-blue-400"
                        }`}
                      />
                    </div>

                    <div className="space-y-1">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Notiz (optional)</label>
                      <input
                        value={newStock.note}
                        onChange={e => setNewStock({ ...newStock, note: e.target.value })}
                        placeholder={newStock.source === "produktion" ? "z.B. geprüft / repariert" : "z.B. Lieferant / Bemerkung"}
                        className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none focus:border-yellow-400"
                      />
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Steg (Suche)</label>
                    <input
                      list="steg-datalist"
                      required
                      value={newStock.itemKey}
                      onChange={e => setNewStock({ ...newStock, itemKey: e.target.value })}
                      placeholder="Tippen zum Suchen… (z.B. STEG_...)"
                      className="w-full p-4 bg-slate-50 rounded-2xl font-black border-2 border-slate-100 outline-none focus:border-yellow-400"
                    />
                    <datalist id="steg-datalist">
                      {stegItems.map(s => <option key={s.id} value={s.code} />)}
                    </datalist>

                    {recentStegs.length > 0 && (
                      <div className="flex flex-wrap gap-2 pt-1">
                        {recentStegs.map(k => (
                          <button
                            key={k}
                            type="button"
                            onClick={() => setNewStock({ ...newStock, itemKey: k })}
                            className={`px-3 py-2 rounded-full text-[10px] font-black uppercase border transition-all ${
                              newStock.itemKey === k
                                ? "bg-slate-900 text-yellow-500 border-slate-900"
                                : "bg-white text-slate-700 border-slate-200 hover:border-yellow-400"
                            }`}
                          >
                            {k}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Regal (C)</label>
                      <select
                        value={newStock.shelf}
                        onChange={e => setNewStock({ ...newStock, shelf: e.target.value })}
                        className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none"
                      >
                        {shelves.map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                    </div>
                    <div className="space-y-1">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Ebene</label>
                      <select
                        value={newStock.level}
                        onChange={e => setNewStock({ ...newStock, level: Number(e.target.value) })}
                        className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none"
                      >
                        {levels.map(l => <option key={l} value={l}>Ebene {l}</option>)}
                      </select>
                    </div>
                  </div>

                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Stückzahl</label>
                    <input
                      required
                      type="number"
                      min="1"
                      placeholder="Menge..."
                      value={newStock.qty}
                      onChange={e => setNewStock({ ...newStock, qty: e.target.value })}
                      className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none focus:border-emerald-400"
                    />
                  </div>

                  <button
                    type="submit"
                    className={`w-full py-5 text-white rounded-[1.5rem] font-black uppercase shadow-lg active:scale-95 transition-all ${
                      newStock.source === "anlieferung"
                        ? "bg-emerald-600 shadow-emerald-600/20"
                        : "bg-blue-600 shadow-blue-600/20"
                    }`}
                  >
                    {newStock.source === "anlieferung" ? "Einlagern (Anlieferung)" : "Einlagern (Rücklauf)"}
                  </button>
                </form>
              </div>
            )}

            {activeTab === "move" && (
              <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-200 space-y-6">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-100 text-blue-600 rounded-xl"><Icon name="shuffle" /></div>
                  <h3 className="font-black uppercase text-slate-800 italic text-xl">Umlagern</h3>
                </div>

                <form onSubmit={handleMoveStock} className="space-y-5">
                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Was umlagern?</label>
                    <select
                      required
                      value={moveStock.entryId}
                      onChange={e => {
                        const entryId = e.target.value;
                        const entry = entryOptions.find(x => x.entryId === entryId);
                        setMoveStock({ ...moveStock, entryId, qty: entry ? entry.quantity : "" });
                      }}
                      className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 appearance-none outline-none focus:border-blue-400"
                    >
                      <option value="">-- Bestand wählen --</option>
                      {entryOptions.map(e => (
                        <option key={e.entryId} value={e.entryId}>
                          {e.shelf}-L{e.level} | {e.itemKey} ({e.quantity} Stk)
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Stückzahl (Festwert)</label>
                    <input
                      readOnly
                      type="number"
                      value={moveStock.qty}
                      className="w-full p-4 bg-slate-200 rounded-2xl font-bold border-2 border-slate-100 outline-none cursor-not-allowed opacity-75"
                    />
                    <p className="text-[9px] text-slate-400 ml-4 italic mt-1">* Die gesamte Menge dieses Eintrags wird verschoben.</p>
                  </div>

                  <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-100">
                    <div className="space-y-1">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Ziel Regal</label>
                      <select
                        value={moveStock.targetShelf}
                        onChange={e => setMoveStock({ ...moveStock, targetShelf: e.target.value })}
                        className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none"
                      >
                        {shelves.map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                    </div>
                    <div className="space-y-1">
                      <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Ziel Ebene</label>
                      <select
                        value={moveStock.targetLevel}
                        onChange={e => setMoveStock({ ...moveStock, targetLevel: Number(e.target.value) })}
                        className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none"
                      >
                        {levels.map(l => <option key={l} value={l}>Ebene {l}</option>)}
                      </select>
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={!moveStock.entryId}
                    className={`w-full py-5 text-white rounded-[1.5rem] font-black uppercase shadow-lg active:scale-95 transition-all ${
                      moveStock.entryId ? "bg-blue-600 shadow-blue-600/20" : "bg-slate-300 shadow-none cursor-not-allowed"
                    }`}
                  >
                    Umlagerung ausführen
                  </button>
                </form>
              </div>
            )}

            {activeTab === "outbound" && (
              <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-200 space-y-6">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-rose-100 text-rose-600 rounded-xl"><Icon name="arrow-up-right-from-circle" /></div>
                  <h3 className="font-black uppercase text-slate-800 italic text-xl">Warenausgang</h3>
                </div>

                <form onSubmit={handleRemoveStock} className="space-y-5">
                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Eintrag wählen</label>
                    <select
                      required
                      value={outStock.entryId}
                      onChange={e => setOutStock({ ...outStock, entryId: e.target.value })}
                      className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 appearance-none outline-none focus:border-rose-400"
                    >
                      <option value="">-- Bestand wählen --</option>
                      {entryOptions.map(e => (
                        <option key={e.entryId} value={e.entryId}>
                          {e.shelf}-L{e.level} | {e.itemKey} ({e.quantity} Stk)
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Verwendung</label>
                    <select
                      value={outStock.destination}
                      onChange={e => setOutStock({ ...outStock, destination: e.target.value })}
                      className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none"
                    >
                      <option value="produktion">Produktion / Montage</option>
                      <option value="ausschuss">Ausschuss / Defekt</option>
                      <option value="inventur">Korrektur</option>
                    </select>
                  </div>

                  <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400 ml-4">Entnahmemenge</label>
                    <input
                      required
                      type="number"
                      min="1"
                      placeholder="Menge..."
                      value={outStock.qty}
                      onChange={e => setOutStock({ ...outStock, qty: e.target.value })}
                      className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none focus:border-rose-400"
                    />
                  </div>

                  <button
                    type="submit"
                    className="w-full py-5 bg-rose-600 text-white rounded-[1.5rem] font-black uppercase shadow-lg shadow-rose-600/20 active:scale-95 transition-all"
                  >
                    Auslagern bestätigen
                  </button>
                </form>
              </div>
            )}
          </main>

          <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-[520px] glass-effect rounded-[2.5rem] p-2 flex justify-around shadow-2xl border border-white/10 z-[100]">
            <NavBtn active={activeTab === "dashboard"} onClick={() => setActiveTab("dashboard")} icon="layout-dashboard" label="Home" />
            <NavBtn active={activeTab === "inventory"} onClick={() => setActiveTab("inventory")} icon="boxes" label="Bestand" />
            <NavBtn active={activeTab === "add"} onClick={() => setActiveTab("add")} icon="arrow-down-to-dot" label="Eingang" color="emerald" />
            <NavBtn active={activeTab === "move"} onClick={() => setActiveTab("move")} icon="shuffle" label="Umlagern" color="blue" />
            <NavBtn active={activeTab === "outbound"} onClick={() => setActiveTab("outbound")} icon="arrow-up-right-from-circle" label="Ausgang" color="rose" />
          </nav>
        </div>
      );
    }

    const NavBtn = ({ active, onClick, icon, label, color = "yellow" }) => {
      const activeColors = {
        yellow: "bg-yellow-500 text-slate-900",
        emerald: "bg-emerald-500 text-white",
        rose: "bg-rose-500 text-white",
        blue: "bg-blue-500 text-white"
      };

      return (
        <button
          onClick={onClick}
          className={`flex flex-col items-center gap-1 p-2.5 px-3 rounded-3xl transition-all duration-300 ${
            active ? activeColors[color] + " scale-105 shadow-xl" : "text-slate-500 hover:text-slate-300"
          }`}
        >
          <Icon name={icon} size={18} />
          <span className="text-[7px] font-black uppercase tracking-tighter">{label}</span>
        </button>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>

